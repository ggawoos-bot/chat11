<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸ˆì—°ì‚¬ì—… ì§€ì¹¨ ë¬¸ì˜ Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-bg': '#131314',
              'brand-surface': '#1e1f20',
              'brand-primary': '#8ab4f8',
              'brand-secondary': '#4e5052',
              'brand-text-primary': '#e8eaed',
              'brand-text-secondary': '#bdc1c6',
            }
          }
        }
      }
    </script>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.16.0",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "vite": "https://aistudiocdn.com/vite@^7.1.3"
  }
}
</script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      // Set worker source for pdf.js from CDN
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-brand-bg text-brand-text-primary">
    <div id="root"></div>
    <script>
      // WARNING: Do not expose your API key in production.
      // This is for demonstration purposes only.
      window.process = {
        env: {
          API_KEY: 'AIzaSyCQHIDHCFKit9tGZuWgW82aFWNrY6AM5XU'
        }
      }
    </script>
    <script type="text/babel" data-type="module">
      import { GoogleGenAI } from "@google/genai";

      const { useState, useCallback, useMemo, useRef, useEffect, StrictMode } = React;

      // --- Inlined from types.ts ---
      const Role = {
        USER: 'user',
        MODEL: 'model',
      };
      
      // --- Inlined from services/geminiService.ts ---
      if (!process.env.API_KEY) {
          throw new Error("API_KEY environment variable not set");
      }
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const SYSTEM_INSTRUCTION_TEMPLATE = `You are an expert assistant. Your name is NotebookLM Assistant. 
      You must answer questions based ONLY on the following source material provided. 
      Do not use any external knowledge or your pre-trained knowledge. 
      If the answer cannot be found in the source material, you must state that the information is not available in the provided context. 
      Be concise, helpful, and cite which part of the source you are referring to if possible.

      Here is the source material:
      ---START OF SOURCE---
      {sourceText}
      ---END OF SOURCE---`;

      function createNotebookChatSession(sourceText) {
          const systemInstruction = SYSTEM_INSTRUCTION_TEMPLATE.replace('{sourceText}', sourceText);

          const chat = ai.chats.create({
              model: 'gemini-2.5-flash',
              config: {
                  systemInstruction: systemInstruction,
              },
              history: [],
          });
          return chat;
      }

      // --- Inlined from components/icons/UserIcon.tsx ---
      const UserIcon = ({ className = "w-6 h-6" }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
      );

      // --- Inlined from components/icons/BotIcon.tsx ---
      const BotIcon = ({ className = "w-6 h-6" }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.98 10.98c0-4.96-4.02-8.98-8.98-8.98S2 6.02 2 10.98v3.03c0 .54.44.99.99.99h1.01V12h-2c0-4.41 3.59-8 8-8s8 3.59 8 8v2.01h-2v-2.01c0-.54-.44-.99-.99-.99H18v2.01h2v-2.04zM12 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm1.5-1.5c0-.83-.67-1.5-1.5-1.5S12 10.67 12 11.5s.67 1.5 1.5 1.5.5-.67.5-1.5z" opacity=".3" />
              <path d="M21 12v-1.02c0-4.96-4.02-8.98-8.98-8.98S3.04 6.02 3.04 10.98V12H2v2.01h1.05v2.99c0 .54.44.99.99.99H6v-2.01H4.04v-2.99H20v2.99h-2.01V20h2.01c.54 0 .99-.44.99-.99v-2.99H22V12h-1zm-9 3c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm1.5-1.5c0-.83-.67-1.5-1.5-1.5S10.5 10.67 10.5 11.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5z" />
          </svg>
      );

      // --- Inlined from components/icons/SendIcon.tsx ---
      const SendIcon = ({ className = "w-6 h-6" }) => (
          <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
          </svg>
      );
      
      // --- Inlined from components/icons/DocumentIcon.tsx ---
      const DocumentIcon = ({ className = "w-6 h-6" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m-1.5 0-3.75 3.75m3.75-3.75V4.5m0 13.5h-3a1.5 1.5 0 0 1-1.5-1.5v-10.5a1.5 1.5 0 0 1 1.5-1.5h3.75a1.5 1.5 0 0 1 1.5 1.5v10.5a1.5 1.5 0 0 1-1.5-1.5h-3.75Z" />
        </svg>
      );

      // --- New Component: SourceInfo ---
      const SourceInfo = ({ isLoading, files }) => (
          <div className="flex flex-col h-full bg-brand-surface rounded-lg p-4">
              <h2 className="text-lg font-semibold text-brand-primary mb-3">ìë£Œ ì¶œì²˜</h2>
              {isLoading ? (
                  <div className="flex flex-col items-center justify-center flex-1">
                      <div className="w-8 h-8 border-4 border-brand-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                      <p className="text-brand-text-primary">ë¬¸ì„œ ëª©ë¡ í™•ì¸ ë° ë¡œë”© ì¤‘...</p>
                      <p className="text-sm text-brand-text-secondary">ìë£Œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                  </div>
              ) : (
                  <div>
                      <p className="text-sm text-brand-text-secondary mb-4">
                          ì±—ë´‡ì€ ì•„ë˜ ë¬¸ì„œë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.
                      </p>
                      <ul className="space-y-2">
                          {files.map((file, index) => (
                              <li key={index} className="flex items-center gap-2 text-brand-text-secondary text-sm">
                                  <DocumentIcon className="w-5 h-5 flex-shrink-0" />
                                  <span>{file}</span>
                              </li>
                          ))}
                      </ul>
                  </div>
              )}
          </div>
      );
      
      // --- Inlined from components/Message.tsx ---
      const Message = ({ message }) => {
          const isUser = message.role === Role.USER;

          return (
              <div className={`flex items-start gap-4 p-4 ${isUser ? '' : 'bg-brand-surface/50 rounded-lg'}`}>
                  <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isUser ? 'bg-brand-secondary' : 'bg-brand-primary'}`}>
                      {isUser ? <UserIcon className="w-5 h-5 text-brand-text-primary" /> : <BotIcon className="w-5 h-5 text-brand-bg" />}
                  </div>
                  <div className="flex-1 pt-1">
                      <p className="font-semibold text-brand-text-primary mb-1">{isUser ? 'You' : 'Assistant'}</p>
                      <p className="text-brand-text-secondary whitespace-pre-wrap">{message.content}</p>
                  </div>
              </div>
          );
      };
      
      // --- Inlined from components/StatusIndicator.tsx ---
      const StatusIndicator = ({ 
          cacheStats, 
          queueStatus, 
          isLoading = false, 
          error = null, 
          className = "" 
      }) => {
          const formatBytes = (bytes) => {
              if (bytes === 0) return '0 Bytes';
              const k = 1024;
              const sizes = ['Bytes', 'KB', 'MB', 'GB'];
              const i = Math.floor(Math.log(bytes) / Math.log(k));
              return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          };

          const formatPercentage = (value) => {
              return (value * 100).toFixed(1) + '%';
          };

          return (
              <div className={`bg-brand-surface rounded-lg p-4 space-y-3 ${className}`}>
                  <h3 className="text-lg font-semibold text-brand-primary mb-3">ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                  
                  {/* ë¡œë”© ìƒíƒœ */}
                  {isLoading && (
                      <div className="flex items-center gap-2 text-brand-text-secondary">
                          <div className="w-4 h-4 border-2 border-brand-primary border-t-transparent rounded-full animate-spin"></div>
                          <span>ì²˜ë¦¬ ì¤‘...</span>
                      </div>
                  )}

                  {/* ì—ëŸ¬ ìƒíƒœ */}
                  {error && (
                      <div className="flex items-center gap-2 text-red-400 bg-red-900/20 p-2 rounded">
                          <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                          </svg>
                          <span className="text-sm">{error}</span>
                      </div>
                  )}

                  {/* ìºì‹œ ìƒíƒœ */}
                  {cacheStats && (
                      <div className="space-y-2">
                          <h4 className="text-sm font-medium text-brand-text-primary">ìºì‹œ ìƒíƒœ</h4>
                          <div className="grid grid-cols-2 gap-2 text-sm">
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">í•­ëª© ìˆ˜:</span>
                                  <span className="text-brand-text-primary">{cacheStats.totalItems}</span>
                              </div>
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">íˆíŠ¸ìœ¨:</span>
                                  <span className="text-brand-text-primary">{formatPercentage(cacheStats.hitRate)}</span>
                              </div>
                              <div className="flex justify-between col-span-2">
                                  <span className="text-brand-text-secondary">ì´ í¬ê¸°:</span>
                                  <span className="text-brand-text-primary">{formatBytes(cacheStats.totalSize)}</span>
                              </div>
                          </div>
                          
                          {/* íˆíŠ¸ìœ¨ ì‹œê°í™” */}
                          <div className="w-full bg-brand-secondary rounded-full h-2">
                              <div 
                                  className="bg-brand-primary h-2 rounded-full transition-all duration-300"
                                  style={{ width: `${cacheStats.hitRate * 100}%` }}
                              ></div>
                          </div>
                      </div>
                  )}

                  {/* ìš”ì²­ í ìƒíƒœ */}
                  {queueStatus && (
                      <div className="space-y-2">
                          <h4 className="text-sm font-medium text-brand-text-primary">ìš”ì²­ í</h4>
                          <div className="grid grid-cols-2 gap-2 text-sm">
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">ëŒ€ê¸°:</span>
                                  <span className="text-yellow-400">{queueStatus.pendingCount}</span>
                              </div>
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">ì²˜ë¦¬ì¤‘:</span>
                                  <span className="text-blue-400">{queueStatus.processingCount}</span>
                              </div>
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">ì‹¤íŒ¨:</span>
                                  <span className="text-red-400">{queueStatus.failedCount}</span>
                              </div>
                              <div className="flex justify-between">
                                  <span className="text-brand-text-secondary">ì´ í:</span>
                                  <span className="text-brand-text-primary">{queueStatus.totalLength}</span>
                              </div>
                          </div>
                      </div>
                  )}

                  {/* ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½ */}
                  <div className="pt-2 border-t border-brand-secondary">
                      <div className="flex items-center justify-between text-sm">
                          <span className="text-brand-text-secondary">ì‹œìŠ¤í…œ ìƒíƒœ:</span>
                          <div className="flex items-center gap-1">
                              {error ? (
                                  <>
                                      <div className="w-2 h-2 bg-red-400 rounded-full"></div>
                                      <span className="text-red-400">ì˜¤ë¥˜</span>
                                  </>
                              ) : isLoading ? (
                                  <>
                                      <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                                      <span className="text-yellow-400">ì²˜ë¦¬ì¤‘</span>
                                  </>
                              ) : (
                                  <>
                                      <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                                      <span className="text-green-400">ì •ìƒ</span>
                                  </>
                              )}
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      // --- Inlined from components/CacheStats.tsx ---
      const CacheStats = ({ 
          stats, 
          onClearCache, 
          className = "" 
      }) => {
          const formatBytes = (bytes) => {
              if (bytes === 0) return '0 Bytes';
              const k = 1024;
              const sizes = ['Bytes', 'KB', 'MB', 'GB'];
              const i = Math.floor(Math.log(bytes) / Math.log(k));
              return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          };

          const formatPercentage = (value) => {
              return (value * 100).toFixed(1) + '%';
          };

          const getHitRateColor = (rate) => {
              if (rate >= 0.7) return 'text-green-400';
              if (rate >= 0.4) return 'text-yellow-400';
              return 'text-red-400';
          };

          const getHitRateBarColor = (rate) => {
              if (rate >= 0.7) return 'bg-green-400';
              if (rate >= 0.4) return 'bg-yellow-400';
              return 'bg-red-400';
          };

          return (
              <div className={`bg-brand-surface rounded-lg p-4 space-y-4 ${className}`}>
                  <div className="flex items-center justify-between">
                      <h3 className="text-lg font-semibold text-brand-primary">ìºì‹œ í†µê³„</h3>
                      {onClearCache && (
                          <button
                              onClick={onClearCache}
                              className="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors"
                          >
                              ìºì‹œ ì´ˆê¸°í™”
                          </button>
                      )}
                  </div>

                  {/* íˆíŠ¸ìœ¨ í‘œì‹œ */}
                  <div className="space-y-2">
                      <div className="flex items-center justify-between">
                          <span className="text-sm font-medium text-brand-text-primary">ìºì‹œ íˆíŠ¸ìœ¨</span>
                          <span className={`text-lg font-bold ${getHitRateColor(stats.hitRate)}`}>
                              {formatPercentage(stats.hitRate)}
                          </span>
                      </div>
                      
                      {/* íˆíŠ¸ìœ¨ í”„ë¡œê·¸ë ˆìŠ¤ ë°” */}
                      <div className="w-full bg-brand-secondary rounded-full h-3">
                          <div 
                              className={`h-3 rounded-full transition-all duration-500 ${getHitRateBarColor(stats.hitRate)}`}
                              style={{ width: `${stats.hitRate * 100}%` }}
                          ></div>
                      </div>
                      
                      {/* íˆíŠ¸/ë¯¸ìŠ¤ ì¹´ìš´íŠ¸ */}
                      <div className="flex justify-between text-xs text-brand-text-secondary">
                          <span>íˆíŠ¸: {stats.hitCount}</span>
                          <span>ë¯¸ìŠ¤: {stats.missCount}</span>
                      </div>
                  </div>

                  {/* ê¸°ë³¸ í†µê³„ */}
                  <div className="grid grid-cols-2 gap-3 text-sm">
                      <div className="space-y-1">
                          <div className="flex justify-between">
                              <span className="text-brand-text-secondary">ì´ í•­ëª©:</span>
                              <span className="text-brand-text-primary font-medium">{stats.totalItems}</span>
                          </div>
                          <div className="flex justify-between">
                              <span className="text-brand-text-secondary">ë§Œë£Œëœ í•­ëª©:</span>
                              <span className="text-orange-400">{stats.expiredItems}</span>
                          </div>
                      </div>
                      
                      <div className="space-y-1">
                          <div className="flex justify-between">
                              <span className="text-brand-text-secondary">ì´ í¬ê¸°:</span>
                              <span className="text-brand-text-primary font-medium">{formatBytes(stats.totalSize)}</span>
                          </div>
                          <div className="flex justify-between">
                              <span className="text-brand-text-secondary">í‰ê·  í¬ê¸°:</span>
                              <span className="text-brand-text-primary">{formatBytes(stats.averageItemSize)}</span>
                          </div>
                      </div>
                  </div>

                  {/* ê°€ì¥ ë§ì´ ì ‘ê·¼ëœ í•­ëª© */}
                  {stats.mostAccessedItem && (
                      <div className="pt-2 border-t border-brand-secondary">
                          <div className="text-xs text-brand-text-secondary">
                              <span className="font-medium">ê°€ì¥ ë§ì´ ì ‘ê·¼ëœ í•­ëª©:</span>
                              <div className="mt-1 p-2 bg-brand-bg rounded text-brand-text-primary font-mono text-xs truncate">
                                  {stats.mostAccessedItem}
                              </div>
                          </div>
                      </div>
                  )}

                  {/* ì„±ëŠ¥ ì§€í‘œ */}
                  <div className="pt-2 border-t border-brand-secondary">
                      <div className="text-xs text-brand-text-secondary space-y-1">
                          <div className="flex justify-between">
                              <span>API í˜¸ì¶œ ì ˆì•½:</span>
                              <span className="text-green-400 font-medium">
                                  {formatPercentage(stats.hitRate)} ê°ì†Œ
                              </span>
                          </div>
                          <div className="flex justify-between">
                              <span>ì˜ˆìƒ ì‘ë‹µ ì‹œê°„:</span>
                              <span className="text-blue-400 font-medium">
                                  {stats.hitRate > 0.5 ? '< 100ms' : '1-2ì´ˆ'}
                              </span>
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      // --- Inlined from components/MessageInput.tsx ---
      const MessageInput = ({ 
          currentMessage, 
          setCurrentMessage, 
          onSendMessage, 
          isLoading, 
          disabled,
          lastMessageTime = 0,
          maxLength = 500,
          minInterval = 5000,  // 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ë³€ê²½
          retryCountdown = 0,
          lastSentMessage = ''
      }) => {
          const [inputError, setInputError] = useState('');
          const [remainingTime, setRemainingTime] = useState(0);
          
          const isInputDisabled = isLoading || disabled || remainingTime > 0;
          const timeSinceLastMessage = Date.now() - lastMessageTime;
          const canSend = timeSinceLastMessage >= minInterval;
          
          // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
          useEffect(() => {
              if (!canSend && lastMessageTime > 0) {
                  const interval = setInterval(() => {
                      const elapsed = Date.now() - lastMessageTime;
                      const remaining = Math.max(0, minInterval - elapsed);
                      setRemainingTime(remaining);
                      
                      if (remaining === 0) {
                          clearInterval(interval);
                      }
                  }, 100);
                  
                  return () => clearInterval(interval);
              }
          }, [canSend, lastMessageTime, minInterval]);
          
          // ì…ë ¥ ê²€ì¦
          const handleInputChange = (e) => {
              const value = e.target.value;
              
              // ê¸¸ì´ ì œí•œ
              if (value.length > maxLength) {
                  setInputError(`ë©”ì‹œì§€ëŠ” ${maxLength}ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                  return;
              }
              
              // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
              setInputError('');
              setCurrentMessage(value);
          };
          
          // ì „ì†¡ ì²˜ë¦¬
          const handleSubmit = (e) => {
              e.preventDefault();
              
              if (!currentMessage.trim()) {
                  setInputError('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                  return;
              }
              
              if (!canSend) {
                  setInputError(`ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (${Math.ceil(remainingTime / 1000)}ì´ˆ ë‚¨ìŒ)`);
                  return;
              }
              
              // ì¤‘ë³µ ë©”ì‹œì§€ ê²€ì‚¬ (ì„ íƒì  - í•„ìš”ì‹œ í™œì„±í™”)
              // if (currentMessage.trim() === lastSentMessage.trim()) {
              //     setInputError('ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ì—°ì†ìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              //     return;
              // }
              
              setInputError('');
              onSendMessage(e);
          };
          
          const formatTime = (ms) => {
              return Math.ceil(ms / 1000);
          };

          return (
              <form onSubmit={handleSubmit} className="p-4 bg-brand-surface">
                  {/* ì…ë ¥ ì œí•œ ìƒíƒœ í‘œì‹œ */}
                  {remainingTime > 0 && (
                      <div className="mb-2 p-2 bg-yellow-900/20 border border-yellow-600/30 rounded text-yellow-300 text-sm">
                          <div className="flex items-center gap-2">
                              <div className="w-4 h-4 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin"></div>
                              <span>ë‹¤ìŒ ë©”ì‹œì§€ê¹Œì§€ {formatTime(remainingTime)}ì´ˆ ëŒ€ê¸° ì¤‘...</span>
                          </div>
                      </div>
                  )}
                  
                  {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
                  {inputError && (
                      <div className="mb-2 p-2 bg-red-900/20 border border-red-600/30 rounded text-red-300 text-sm">
                          {inputError}
                      </div>
                  )}
                  
                  <div className="relative">
                      <input
                          type="text"
                          value={currentMessage}
                          onChange={handleInputChange}
                          onKeyDown={(e) => {
                              // ìŠ¤í˜ì´ìŠ¤ë°” ì…ë ¥ ë³´ì¥
                              if (e.key === ' ') {
                                  e.stopPropagation();
                              }
                          }}
                          onKeyUp={(e) => {
                              // ìŠ¤í˜ì´ìŠ¤ë°” ì…ë ¥ ë³´ì¥
                              if (e.key === ' ') {
                                  e.stopPropagation();
                              }
                          }}
                          placeholder={
                              disabled ? "ìë£Œë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤..." : 
                              retryCountdown > 0 ? `ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (${Math.floor(retryCountdown / 60)}:${String(retryCountdown % 60).padStart(2, '0')} í›„ ì „ì†¡ ê°€ëŠ¥)` :
                              remainingTime > 0 ? `ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”...` :
                              "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                          }
                          disabled={isInputDisabled}
                          className="w-full bg-brand-bg border border-brand-secondary rounded-full py-3 pl-4 pr-12 text-brand-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary disabled:opacity-50"
                          maxLength={maxLength}
                      />
                      <button
                          type="submit"
                          disabled={isInputDisabled || !currentMessage.trim() || retryCountdown > 0}
                          title={
                              retryCountdown > 0 ? `API í•œë„ ì´ˆê³¼ - ${Math.floor(retryCountdown / 60)}:${String(retryCountdown % 60).padStart(2, '0')} í›„ ì‚¬ìš© ê°€ëŠ¥` :
                              remainingTime > 0 ? "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”" :
                              isLoading ? "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..." :
                              !currentMessage.trim() ? "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" :
                              "ì „ì†¡"
                          }
                          className="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full text-brand-primary hover:bg-brand-primary/20 disabled:text-brand-secondary disabled:hover:bg-transparent transition-colors"
                      >
                          <SendIcon className="w-6 h-6" />
                      </button>
                  </div>
                  
                  {/* ê¸€ì ìˆ˜ í‘œì‹œ */}
                  <div className="mt-2 flex justify-between text-xs text-brand-text-secondary">
                      <span>{currentMessage.length} / {maxLength}ì</span>
                      {lastMessageTime > 0 && (
                          <span>
                              ë§ˆì§€ë§‰ ë©”ì‹œì§€: {formatTime(timeSinceLastMessage)}ì´ˆ ì „
                          </span>
                      )}
                  </div>
              </form>
          );
      };

      // --- Inlined from components/ChatWindow.tsx ---
      const ChatWindow = ({ messages, isLoading, sourceProvided, isParsingDocs }) => {
          const scrollRef = useRef(null);

          useEffect(() => {
              if (scrollRef.current) {
                  scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
              }
          }, [messages, isLoading]);

          return (
              <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4">
                   {messages.length === 0 && isParsingDocs && (
                        <div className="text-center text-brand-text-secondary p-8 flex flex-col items-center justify-center h-full">
                            <div className="w-8 h-8 border-4 border-brand-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                            <h3 className="text-xl font-semibold text-brand-text-primary">ìë£Œ ë¡œë”© ì¤‘</h3>
                            <p>ì±—ë´‡ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ë¬¸ì„œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                   )}
                   {messages.length === 0 && !isParsingDocs && !sourceProvided && (
                        <div className="text-center text-brand-text-secondary p-8 flex flex-col items-center justify-center h-full">
                            <DocumentIcon className="w-12 h-12 mb-4 text-brand-secondary" />
                            <h3 className="text-xl font-semibold text-brand-text-primary">ì˜¤ë¥˜ ë°œìƒ</h3>
                            <p>ë¬¸ì„œ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>
                        </div>
                   )}
                   {messages.length === 0 && !isParsingDocs && sourceProvided && (
                      <div className="text-center text-brand-text-secondary p-8 flex flex-col items-center">
                          <BotIcon className="w-12 h-12 mb-4 text-brand-primary" />
                          <h3 className="text-xl font-semibold text-brand-text-primary">ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ</h3>
                          <p>ë¬¸ì„œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                      </div>
                  )}
                  {messages.map((msg, index) => (
                      <Message key={index} message={msg} />
                  ))}
                  {isLoading && messages.length > 0 && messages[messages.length - 1].role === 'user' && (
                       <div className="flex items-start gap-4 p-4 bg-brand-surface/50 rounded-lg">
                          <div className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-brand-primary">
                              <BotIcon className="w-5 h-5 text-brand-bg" />
                          </div>
                          <div className="flex-1 pt-1">
                              <p className="font-semibold text-brand-text-primary mb-1">Assistant</p>
                              <div className="flex items-center gap-2">
                                  <span className="w-2 h-2 bg-brand-text-secondary rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                                  <span className="w-2 h-2 bg-brand-text-secondary rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                                  <span className="w-2 h-2 bg-brand-text-secondary rounded-full animate-pulse"></span>
                              </div>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // --- Inlined from App.tsx ---
      const App = () => {
          const [sourceText, setSourceText] = useState('');
          const [messages, setMessages] = useState([]);
          const [currentMessage, setCurrentMessage] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const [lastSentMessage, setLastSentMessage] = useState('');
          const [isParsing, setIsParsing] = useState(true);
          const [discoveredFiles, setDiscoveredFiles] = useState([]);
          const [error, setError] = useState(null);
          
          // ìƒˆë¡œìš´ ìƒíƒœ ì¶”ê°€
          const [lastMessageTime, setLastMessageTime] = useState(0);
          const [cacheStats, setCacheStats] = useState({
              totalItems: 0,
              hitRate: 0,
              totalSize: 0
          });
          const [queueStatus, setQueueStatus] = useState({
              totalLength: 0,
              pendingCount: 0,
              processingCount: 0,
              failedCount: 0
          });
          const [showStats, setShowStats] = useState(false);
          
          // ë‹¤ìŒ ì‹œë„ ê°€ëŠ¥ì‹œê°„ ê´€ë ¨ ìƒíƒœ
          const [retryCountdown, setRetryCountdown] = useState(0);
          const [nextRetryTime, setNextRetryTime] = useState(null);

          const PDF_BASE_URL = 'https://ggawoos-bot.github.io/chat2/pdf/';

          const chatSession = useMemo(() => {
              if (sourceText.trim()) {
                  try {
                    return createNotebookChatSession(sourceText);
                  } catch (e) {
                    console.error("Error creating chat session:", e);
                    setError(e instanceof Error ? e.message : "Failed to create chat session.");
                    return null;
                  }
              }
              return null;
          }, [sourceText]);
          
          const parsePdfFromUrl = async (url) => {
              try {
                  const pdfData = await fetch(url).then(res => {
                      if (!res.ok) {
                          throw new Error(`Failed to fetch ${url}: ${res.statusText}`);
                      }
                      return res.arrayBuffer();
                  });
                  const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(pdfData) }).promise;
                  let fullText = '';
                  for (let i = 1; i <= pdf.numPages; i++) {
                      const page = await pdf.getPage(i);
                      const textContent = await page.getTextContent();
                      const pageText = textContent.items.map(item => item.str).join(' ');
                      fullText += pageText + '\n\n';
                  }
                  return fullText;
              } catch (err) {
                  console.error(`Error parsing PDF from ${url}:`, err);
                  throw new Error(`Failed to parse ${url.split('/').pop()}: ${err.message}`);
              }
          };

          useEffect(() => {
            const discoverAndParsePdfs = async () => {
                setIsParsing(true);
                setError(null);
                setSourceText('');
                setMessages([]);
                setDiscoveredFiles([]);

                try {
                    // Step 1: Fetch the manifest file to discover PDF files
                    const manifestUrl = `${PDF_BASE_URL}manifest.json`;
                    const manifestResponse = await fetch(manifestUrl);
                    if (!manifestResponse.ok) {
                        throw new Error(`Could not load file list (manifest.json). Status: ${manifestResponse.statusText}`);
                    }
                    const pdfFiles = await manifestResponse.json();

                    if (!Array.isArray(pdfFiles) || pdfFiles.length === 0) {
                        throw new Error("No PDF files found in manifest.json or the file is invalid.");
                    }
                    setDiscoveredFiles(pdfFiles);

                    // Step 2: Parse the discovered PDF files
                    const parsingPromises = pdfFiles.map(file => parsePdfFromUrl(PDF_BASE_URL + file));
                    const texts = await Promise.all(parsingPromises);
                    const combinedText = texts.join('\n--- END OF DOCUMENT ---\n\n--- START OF DOCUMENT ---\n');
                    setSourceText(combinedText);
                } catch (err) {
                    console.error("Error loading PDFs:", err);
                    setError(err instanceof Error ? err.message : 'An unknown error occurred during loading.');
                    setDiscoveredFiles([]); // Clear file list on error
                } finally {
                    setIsParsing(false);
                }
            };
            
            discoverAndParsePdfs();
        }, []); // Empty dependency array ensures this runs only once on mount

          const handleSendMessage = useCallback(async (e) => {
              e.preventDefault();
              if (!currentMessage.trim() || !chatSession || isLoading) return;
              
              // API í•œë„ ì´ˆê³¼ ì‹œ ì „ì†¡ ì°¨ë‹¨
              if (retryCountdown > 0) {
                  setError(`ğŸš« API í•œë„ ì´ˆê³¼ - ${Math.floor(retryCountdown / 60)}:${String(retryCountdown % 60).padStart(2, '0')} í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                  return;
              }

              const userMessage = { role: Role.USER, content: currentMessage.trim() };
              setMessages(prev => [...prev, userMessage]);
              setLastSentMessage(currentMessage.trim()); // ë§ˆì§€ë§‰ ì „ì†¡ëœ ë©”ì‹œì§€ ì €ì¥
              setCurrentMessage('');
              setIsLoading(true);
              setError(null);
              setLastMessageTime(Date.now());

              try {
                  const stream = await chatSession.sendMessageStream({ message: userMessage.content });

                  let modelResponse = '';
                  setMessages(prev => [...prev, { role: Role.MODEL, content: '' }]);

                  for await (const chunk of stream) {
                      modelResponse += chunk.text;
                      setMessages(prev => {
                          const newMessages = [...prev];
                          newMessages[newMessages.length - 1].content = modelResponse;
                          return newMessages;
                      });
                  }
                  
                  // ì„±ê³µ ì‹œ í†µê³„ ì—…ë°ì´íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
                  updateStats();
                  
              } catch (err) {
                  console.error(err);
                  let displayMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤, ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';

                  if (err instanceof Error && (err.message.includes('429') || err.message.includes('RESOURCE_EXHAUSTED') || err.message.includes('quota') || err.message.includes('limit'))) {
                      // ì‹¤ì œ API í•œë„ ë³µêµ¬ ì‹œê°„ ê³„ì‚° (ë” ì§§ê²Œ)
                      let retryDelay;
                      if (err.message.includes('429')) {
                          // Rate limit - 30ì´ˆ í›„ ë³µêµ¬
                          retryDelay = 30 * 1000; // 30ì´ˆ
                      } else if (err.message.includes('RESOURCE_EXHAUSTED')) {
                          // Resource exhausted - 2ë¶„ í›„ ë³µêµ¬
                          retryDelay = 2 * 60 * 1000; // 2ë¶„
                      } else {
                          // ê¸°ë³¸ê°’ - 1ë¶„
                          retryDelay = 1 * 60 * 1000; // 1ë¶„
                      }
                      
                      const nextRetry = new Date(Date.now() + retryDelay);
                      setNextRetryTime(nextRetry);
                      
                      const retryTimeString = nextRetry.toLocaleTimeString('ko-KR', {
                          hour: '2-digit',
                          minute: '2-digit'
                      });
                      
                      displayMessage = `ğŸš« ë‹µë³€ ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\nâ° ë‹¤ìŒ ì‹œë„ ê°€ëŠ¥ ì‹œê°„: ${retryTimeString}`;
                      
                      // ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
                      const countdownSeconds = Math.floor(retryDelay / 1000);
                      setRetryCountdown(countdownSeconds);
                      const countdownTimer = setInterval(() => {
                          setRetryCountdown(prev => {
                              if (prev <= 1) {
                                  clearInterval(countdownTimer);
                                  setError(null);
                                  setNextRetryTime(null);
                                  return 0;
                              }
                              return prev - 1;
                          });
                      }, 1000);
                  }
                  
                  setError(displayMessage);
                  
                  setMessages(prev => {
                      const newMessages = [...prev];
                      if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === Role.MODEL) {
                        newMessages.pop();
                      }
                      return [...newMessages, { role: Role.MODEL, content: displayMessage }];
                  });

              } finally {
                  setIsLoading(false);
              }
          }, [chatSession, currentMessage, isLoading]);

          // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì‹œë®¬ë ˆì´ì…˜)
          const updateStats = useCallback(() => {
              // ìºì‹œ í†µê³„ ì‹œë®¬ë ˆì´ì…˜
              setCacheStats(prev => ({
                  totalItems: prev.totalItems + Math.floor(Math.random() * 2),
                  hitRate: Math.min(0.9, prev.hitRate + Math.random() * 0.1),
                  totalSize: prev.totalSize + Math.floor(Math.random() * 1000)
              }));
              
              // í ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜
              setQueueStatus(prev => ({
                  totalLength: Math.max(0, prev.totalLength + Math.floor(Math.random() * 3) - 1),
                  pendingCount: Math.max(0, prev.pendingCount + Math.floor(Math.random() * 2) - 1),
                  processingCount: isLoading ? 1 : 0,
                  failedCount: Math.random() < 0.1 ? prev.failedCount + 1 : prev.failedCount
              }));
          }, [isLoading]);

          // ì£¼ê¸°ì  í†µê³„ ì—…ë°ì´íŠ¸
          useEffect(() => {
              const interval = setInterval(updateStats, 5000);
              return () => clearInterval(interval);
          }, [updateStats]);

          return (
              <div className="h-screen w-screen flex flex-col p-4 gap-4 bg-brand-bg">
                  <header className="text-center">
                      <h1 className="text-2xl font-bold text-brand-text-primary">ê¸ˆì—°ì‚¬ì—… ì§€ì¹¨ ë¬¸ì˜ Chatbot</h1>
                  </header>
                  
                  <main className="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0">
                      {/* Source Info Column */}
                      <div className="flex flex-col min-h-0">
                           <SourceInfo
                                isLoading={isParsing}
                                files={discoveredFiles}
                           />
                           
                           {/* ìƒíƒœ í‘œì‹œ ì»´í¬ë„ŒíŠ¸ */}
                           <div className="mt-4">
                               <StatusIndicator
                                   cacheStats={cacheStats}
                                   queueStatus={queueStatus}
                                   isLoading={isLoading}
                                   error={error}
                               />
                           </div>
                           
                           {/* í†µê³„ í† ê¸€ ë²„íŠ¼ */}
                           <div className="mt-4 flex justify-center">
                               <button
                                   onClick={() => setShowStats(!showStats)}
                                   className="px-4 py-2 bg-brand-primary hover:bg-brand-primary/80 text-brand-bg rounded-lg text-sm transition-colors"
                               >
                                   {showStats ? 'í†µê³„ ìˆ¨ê¸°ê¸°' : 'ìƒì„¸ í†µê³„ ë³´ê¸°'}
                               </button>
                           </div>
                           
                           {/* ìƒì„¸ í†µê³„ */}
                           {showStats && (
                               <div className="mt-4">
                                   <CacheStats
                                       stats={{
                                           totalItems: cacheStats.totalItems,
                                           hitCount: Math.floor(cacheStats.hitRate * 100),
                                           missCount: Math.floor((1 - cacheStats.hitRate) * 100),
                                           hitRate: cacheStats.hitRate,
                                           totalSize: cacheStats.totalSize,
                                           averageItemSize: cacheStats.totalItems > 0 ? cacheStats.totalSize / cacheStats.totalItems : 0,
                                           expiredItems: 0,
                                           mostAccessedItem: 'ê¸ˆì—°ì‚¬ì—… ì§€ì¹¨ ê´€ë ¨ ì§ˆë¬¸'
                                       }}
                                       onClearCache={() => {
                                           setCacheStats({ totalItems: 0, hitRate: 0, totalSize: 0 });
                                           console.log('ìºì‹œ ì´ˆê¸°í™”ë¨');
                                       }}
                                   />
                               </div>
                           )}
                      </div>
                      
                      {/* Chat Column */}
                      <div className="flex flex-col h-full bg-brand-surface rounded-lg min-h-0 lg:col-span-2">
                          <div className="flex-1 flex flex-col min-h-0">
                            <div className="flex items-center justify-between p-4 border-b border-brand-secondary">
                                <h2 className="text-lg font-semibold text-brand-primary">ì§ˆë¬¸í•˜ê¸°</h2>
                                {/* ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ */}
                                <div className="flex items-center gap-2 text-sm text-brand-text-secondary">
                                    {isLoading && (
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                            <span>ì²˜ë¦¬ì¤‘</span>
                                        </div>
                                    )}
                                    {queueStatus.processingCount > 0 && (
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                                            <span>í ì²˜ë¦¬ì¤‘ ({queueStatus.processingCount})</span>
                                        </div>
                                    )}
                                    {cacheStats.hitRate > 0 && (
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                                            <span>ìºì‹œ {(cacheStats.hitRate * 100).toFixed(0)}%</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                              <>
                                 {error && (
                                     <div className="p-4 bg-red-900/50 text-red-300 border-b border-red-700">
                                         <div className="whitespace-pre-line text-sm">{error}</div>
                                         
                                         {retryCountdown > 0 && (
                                             <div className="mt-3 space-y-2">
                                                 {/* ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ */}
                                                 <div className="flex items-center justify-between text-sm">
                                                     <div className="flex items-center gap-2">
                                                         <div className="w-3 h-3 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin"></div>
                                                         <span>ëŒ€ê¸° ì¤‘...</span>
                                                     </div>
                                                     <span className="font-mono text-yellow-300">
                                                         {Math.floor(retryCountdown / 60)}:{String(retryCountdown % 60).padStart(2, '0')}
                                                     </span>
                                                 </div>
                                                 
                                                 {/* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */}
                                                 <div className="w-full bg-red-800 rounded-full h-2">
                                                     <div 
                                                         className="bg-gradient-to-r from-yellow-400 to-green-400 h-2 rounded-full transition-all duration-1000"
                                                         style={{ width: `${100 - (retryCountdown / (retryCountdown > 0 ? Math.max(retryCountdown, 60) : 60)) * 100}%` }}
                                                     ></div>
                                                 </div>
                                                 
                                                 {/* ìƒíƒœ ë©”ì‹œì§€ */}
                                                 <div className="text-xs text-red-200">
                                                     {retryCountdown > 90 ? 'ğŸ”´ API í•œë„ ì´ˆê³¼ - ëŒ€ê¸° ì¤‘' :
                                                      retryCountdown > 30 ? 'ğŸŸ¡ ë³µêµ¬ ì¤‘ - ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”' :
                                                      'ğŸŸ¢ ê³§ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤'}
                                                 </div>
                                             </div>
                                         )}
                                     </div>
                                 )}
                                 <ChatWindow 
                                     messages={messages} 
                                     isLoading={isLoading} 
                                     sourceProvided={!!chatSession}
                                     isParsingDocs={isParsing}
                                 />
                                  <MessageInput
                                      currentMessage={currentMessage}
                                      setCurrentMessage={setCurrentMessage}
                                      onSendMessage={handleSendMessage}
                                      isLoading={isLoading}
                                      disabled={!chatSession || isParsing || retryCountdown > 0}
                                      lastMessageTime={lastMessageTime}
                                      maxLength={500}
                                      minInterval={5000}
                                      retryCountdown={retryCountdown}
                                      lastSentMessage={lastSentMessage}
                                  />
                              </>
                          </div>
                      </div>
                  </main>
              </div>
          );
      };

      // --- Inlined from index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <StrictMode>
          <App />
        </StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>